#!/bin/bash -e

NVM_VERSION="0.38.0"
NODE_VERSION="14.17.0"
RUBY_VERSION="3.0.1"
GO_VERSION="1.16.4"
TERRAFORM_VERSION="1.0.5"
DOCKER_COMPOSE_VERSION="1.29.2"

echo "--------------------------------"
echo "Installing Apt Dependencies"
echo "--------------------------------"
sudo apt-get update && sudo apt-get upgrade -y

sudo apt-get install -y \
  apt-transport-https \
  autoconf \
  automake \
  bison \
  build-essential \
  ca-certificates \
  curl \
  git \
  gnupg gnupg-agent \
  gpg \
  keychain \
  libc6-dev libssl-dev libtool libxml2-dev libyaml-dev \
  openssl \
  python3 python3-pip \
  silversearcher-ag \
  software-properties-common \
  tmux \
  tree \
  unzip \
  vim \
  zlib1g zlib1g-dev \
  zsh

echo "--------------------------------"
echo "Installing Docker and Docker Compose"
echo "--------------------------------"
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository \
  "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) \
  stable"
sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli
sudo curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

echo "--------------------------------"
echo "Installing Node"
echo "--------------------------------"
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v$NVM_VERSION/install.sh | bash
source ~/.nvm/nvm.sh
nvm install $NODE_VERSION

echo "--------------------------------"
echo "Installing Ruby"
echo "--------------------------------"
gpg --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
curl -sSL https://get.rvm.io | bash -s stable
source ~/.rvm/scripts/rvm
rvm install $RUBY_VERSION
gem update --system

echo "--------------------------------"
echo "Installing Go"
echo "--------------------------------"
curl -L -o /tmp/go$GO_VERSION.tar.gz https://golang.org/dl/go$GO_VERSION.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf /tmp/go$GO_VERSION.tar.gz
rm /tmp/go$GO_VERSION.tar.gz
export PATH="$PATH:/usr/local/go/bin"

echo "--------------------------------"
echo "Installing Shell Accessories"
echo "--------------------------------"
echo "# oh-my-zsh"
if [[ -d ~/.oh-my-zsh ]]; then
  echo "WARN: Oh My Zsh directory exists at ~/.oh-my-zsh, skipping..."
else
  curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh
fi
echo "# tmuxinator"
gem install tmuxinator

echo "--------------------------------"
echo "Installing Vim Plugins"
echo "--------------------------------"
if [[ -d ~/.vim/autoload ]] || [[ -d ~/.vim/bundle ]]; then
  echo "WARN: Autoload and Bundle directories already exist under ~/.vim, skipping..."
else
  mkdir -p ~/.vim/autoload ~/.vim/bundle
  curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim
  git clone https://github.com/lilydjwg/colorizer ~/.vim/bundle
  git clone https://github.com/scrooloose/nerdtree.git ~/.vim/bundle/nerdtree
  git clone https://tpope.io/vim/surround.git ~/.vim/bundle/surround
fi

echo "--------------------------------"
echo "Installing Git Accessories"
echo "--------------------------------"
echo "# git-secret"
if [[ -z $(cat /etc/apt/sources.list | grep git-secret) ]]; then
  sudo sh -c "echo 'deb https://gitsecret.jfrog.io/artifactory/git-secret-deb git-secret main' >> /etc/apt/sources.list"
  wget -qO - 'https://gitsecret.jfrog.io/artifactory/api/gpg/key/public' | sudo apt-key add -
else
  echo "git-secret apt source exists already"
fi
sudo apt-get update && sudo apt-get install -y git-secret
echo "# git-chglog"
go get -u github.com/git-chglog/git-chglog/cmd/git-chglog
echo "# pre-commit"
pip install pre-commit

echo "--------------------------------"
echo "Installing Terraform and Accessories"
echo "--------------------------------"
echo "# tfvm"
wget -q -O - https://raw.githubusercontent.com/ethanhassett/tfvm/main/install.sh | bash
export PATH="$PATH:$HOME/.tfvm/bin"
echo "# Terraform v$TERRAFORM_VERSION"
if [[ $(tfvm list | grep 1.0.5) ]]; then
  echo "Terraform v$TERRAFORM_VERSION is already installed."
else
  tfvm install $TERRAFORM_VERSION
fi
tfvm use $TERRAFORM_VERSION
echo "# terraform-docs"
GO111MODULE="on" go get github.com/terraform-docs/terraform-docs@v0.15.0
echo "# tflint"
curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
echo "# terrascan"
curl -L "$(curl -s https://api.github.com/repos/accurics/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > /tmp/terrascan.tar.gz
tar -xf /tmp/terrascan.tar.gz -C /tmp terrascan
sudo install /tmp/terrascan /usr/local/bin
rm /tmp/terrascan.tar.gz /tmp/terrascan
echo "# tfsec"
go install github.com/aquasecurity/tfsec/cmd/tfsec@latest
echo "# checkov"
pip install checkov

echo "--------------------------------"
echo "Copying Files"
echo "--------------------------------"
#cp tmux/sysinfo.sh /usr/bin ##Removed temporarily until the script is fixed for WSL 2.
sudo cp tmux/.tmux.conf ~/.tmux.conf
sudo mkdir -p ~/.tmuxinator && sudo cp tmuxinator/erhbg.yml ~/.tmuxinator/erhbg.yml
sudo cp vim/.vimrc ~/.vimrc
sudo mkdir -p ~/.oh-my-zsh/themes && sudo cp zsh/erhbg.zsh-theme ~/.oh-my-zsh/themes/erhbg.zsh-theme
sudo cp zsh/.zshrc ~/.zshrc
sudo mkdir -p ~/.dir_colors && sudo cp zsh/dircolors.256darksolarized ~/.dir_colors/dircolors.256darksolarized

echo "--------------------------------"
echo "System has been bootstrapped successfully, Happy Hacking!"
echo "--------------------------------"
